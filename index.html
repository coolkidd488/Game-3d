<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DEATH NOTE: MODO DIA</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #87CEEB; touch-action: none; font-family: sans-serif; }
        canvas { display: block; position: fixed; top: 0; left: 0; z-index: 5; }
        
        /* Contador e Botão de Tela Cheia */
        #top-right-ui { 
            position: fixed; top: 10px; right: 10px; 
            z-index: 1000; text-align: right; 
        }
        #timer-display { color: #000; font-size: 12px; font-weight: bold; margin-bottom: 5px; }
        #fs-btn { 
            background: rgba(0,0,0,0.5); color: white; border: 1px solid white; 
            padding: 5px 10px; font-size: 10px; border-radius: 4px; cursor: pointer;
        }

        #loading-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #fff; color: #000; display: flex; 
            flex-direction: column; align-items: center; justify-content: center; z-index: 2000; 
        }

        /* Interface do Jogo */
        #ui { position: fixed; top: 10px; left: 10px; color: #000; z-index: 100; pointer-events: none; font-weight: bold; }
        .label { position: absolute; color: white; background: rgba(0,0,0,0.7); padding: 2px 6px; border-radius: 4px; font-size: 12px; transform: translate(-50%, -100%); z-index: 50; border: 1px solid #fff; }

        /* Controles */
        #joy-base { position: fixed; bottom: 30px; left: 30px; width: 100px; height: 100px; background: rgba(0,0,0,0.1); border-radius: 50%; z-index: 200; border: 2px solid #000; }
        #joy-knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: #f00; border-radius: 50%; transform: translate(-50%, -50%); }
        #btn-kill { position: fixed; bottom: 30px; right: 30px; width: 80px; height: 80px; background: #900; border: 2px solid #fff; border-radius: 50%; color: white; z-index: 200; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    </style>
</head>
<body>

<div id="loading-screen">
    <h2>INICIANDO JOGO...</h2>
    <p>Prepare-se para entrar no mapa</p>
</div>

<div id="top-right-ui">
    <div id="timer-display">CARREGANDO...</div>
    <button id="fs-btn" onclick="toggleFS()">TELA CHEIA [ ]</button>
</div>

<div id="ui">KIRA: BUSCANDO L</div>

<div id="joy-base"><div id="joy-knob"></div></div>
<div id="btn-kill">MATAR</div>

<script>
let scene, camera, renderer, player, clock;
let moveForward = 0, moveRight = 0;
let yaw = 0, pitch = 0.6;
let npcs = [];
let rotTouch = { id: -1, x: 0, y: 0 };
let loadTime = 6;

// Tela Cheia
function toggleFS() {
    if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        document.getElementById('fs-btn').innerText = "SAIR TELA CHEIA";
    } else {
        document.exitFullscreen();
        document.getElementById('fs-btn').innerText = "TELA CHEIA [ ]";
    }
}

// Contador
const timerInterval = setInterval(() => {
    loadTime--;
    document.getElementById('timer-display').innerText = "MOTOR 3D EM: " + loadTime + "s";
    if (loadTime <= 0) {
        clearInterval(timerInterval);
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('timer-display').innerText = "MODO DIA ATIVO";
    }
}, 1000);

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87CEEB); // Azul Céu (Dia)
    
    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    clock = new THREE.Clock();

    // Luz do Dia (Sol)
    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
    scene.add(hemiLight);
    const sunLight = new THREE.DirectionalLight(0xffffff, 0.8);
    sunLight.position.set(50, 100, 50);
    scene.add(sunLight);

    // Chão Cinza Claro
    let floor = new THREE.Mesh(new THREE.PlaneGeometry(300, 300), new THREE.MeshPhongMaterial({color: 0x999999}));
    floor.rotation.x = -Math.PI/2;
    scene.add(floor);

    // MAPA DO DESENHO
    const addBuilding = (x, z, w, h, d, col) => {
        let b = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshPhongMaterial({color: col}));
        b.position.set(x, h/2, z);
        scene.add(b);
    };

    // Prédios (PRE) - Agora visíveis no claro
    addBuilding(-20, -20, 10, 30, 10, 0x555555);
    addBuilding(0, -20, 10, 40, 10, 0x666666);
    addBuilding(20, -20, 10, 30, 10, 0x555555);
    addBuilding(-15, 20, 15, 15, 12, 0x777777); // MUSEU

    // CASAS (CA) - Pequenas no canto
    for(let i=0; i<2; i++) {
        for(let j=0; j<4; j++) { 
            addBuilding(15 + j*5, 15 + i*6, 4, 5, 4, 0x885555); 
        }
    }

    // Player (Azul)
    player = new THREE.Group();
    let pBody = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1), new THREE.MeshPhongMaterial({color: 0x0000ff}));
    pBody.position.y = 1;
    player.add(pBody);
    scene.add(player);

    createNPC("L", 0, 10, 0xffcc00, true);
    setupControls();
    animate();
}

function createNPC(name, x, z, col, isL) {
    let g = new THREE.Group();
    let b = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1), new THREE.MeshPhongMaterial({color: col}));
    b.position.y = 1; g.add(b);

    if(isL) {
        let ring = new THREE.Mesh(new THREE.RingGeometry(10.4, 10.6, 64), new THREE.MeshBasicMaterial({color: 0xff0000, side: THREE.DoubleSide}));
        ring.rotation.x = Math.PI/2; ring.position.y = 0.1; g.add(ring);
    }
    g.position.set(x, 0, z);
    scene.add(g);
    npcs.push({mesh: g, name: name});

    let l = document.createElement('div');
    l.className = 'label'; l.id = 'label-'+name; l.innerText = name;
    document.body.appendChild(l);
}

function setupControls() {
    const base = document.getElementById('joy-base');
    const knob = document.getElementById('joy-knob');

    base.addEventListener('touchmove', (e) => {
        let t = e.targetTouches[0];
        let r = base.getBoundingClientRect();
        let dx = t.clientX - (r.left + 50);
        let dy = t.clientY - (r.top + 50);
        let d = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
        let a = Math.atan2(dy, dx);
        knob.style.left = `calc(50% + ${Math.cos(a)*d}px)`;
        knob.style.top = `calc(50% + ${Math.sin(a)*d}px)`;
        moveForward = -Math.sin(a) * (d/40);
        moveRight = Math.cos(a) * (d/40);
    });

    base.addEventListener('touchend', () => {
        knob.style.left = knob.style.top = '50%';
        moveForward = moveRight = 0;
    });

    window.addEventListener('touchstart', (e) => {
        let t = e.touches[e.touches.length-1];
        if(t.clientX > window.innerWidth/2) {
            rotTouch.id = t.identifier; rotTouch.x = t.clientX; rotTouch.y = t.clientY;
        }
    });

    window.addEventListener('touchmove', (e) => {
        for(let i=0; i<e.touches.length; i++) {
            let t = e.touches[i];
            if(t.identifier === rotTouch.id) {
                yaw -= (t.clientX - rotTouch.x) * 0.008;
                pitch = Math.max(0.1, Math.min(1.3, pitch + (t.clientY - rotTouch.y) * 0.006));
                rotTouch.x = t.clientX; rotTouch.y = t.clientY;
            }
        }
    });
}

function animate() {
    requestAnimationFrame(animate);
    if(moveForward || moveRight) {
        player.position.x += (Math.cos(yaw) * moveRight + Math.sin(yaw) * moveForward) * 0.25;
        player.position.z += (Math.sin(yaw) * moveRight - Math.cos(yaw) * moveForward) * 0.25;
        player.rotation.y = yaw;
    }
    let d = 12; // Câmera um pouco mais longe para visão melhor
    camera.position.set(
        player.position.x + Math.sin(yaw) * d * Math.cos(pitch),
        player.position.y + Math.sin(pitch) * d,
        player.position.z + Math.cos(yaw) * d * Math.cos(pitch)
    );
    camera.lookAt(player.position.x, player.position.y + 1, player.position.z);

    npcs.forEach(n => {
        let l = document.getElementById('label-' + n.name);
        let v = n.mesh.position.clone().add(new THREE.Vector3(0, 2, 0));
        v.project(camera);
        l.style.left = (v.x * 0.5 + 0.5) * window.innerWidth + 'px';
        l.style.top = (-(v.y * 0.5) + 0.5) * window.innerHeight + 'px';
        l.style.display = v.z < 1 ? 'block' : 'none';
    });
    renderer.render(scene, camera);
}

window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
});

window.onload = init;
</script>
</body>
</html>


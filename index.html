<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DEATH NOTE: OVERKILL 3D</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #000; touch-action: none; font-family: sans-serif; }
        canvas { display: block; position: fixed; top: 0; left: 0; z-index: 1; }
        
        /* Contador pequeno no canto direito superior */
        #timer-display { 
            position: fixed; 
            top: 5px; 
            right: 10px; 
            color: rgba(255, 255, 255, 0.5); 
            font-size: 10px; 
            z-index: 500; 
            font-family: monospace;
        }

        #loading-screen { 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: #000; color: white; 
            display: flex; align-items: center; justify-content: center; 
            z-index: 1000; 
        }

        #ui { position: fixed; top: 10px; left: 10px; color: white; z-index: 100; pointer-events: none; }
        .label { position: absolute; color: white; background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 4px; font-size: 12px; transform: translate(-50%, -100%); z-index: 50; border: 1px solid #f00; }

        /* Controles */
        #joy-base { position: fixed; bottom: 30px; left: 30px; width: 100px; height: 100px; background: rgba(255,255,255,0.1); border-radius: 50%; z-index: 200; border: 1px solid #fff; }
        #joy-knob { position: absolute; top: 50%; left: 50%; width: 40px; height: 40px; background: #f00; border-radius: 50%; transform: translate(-50%, -50%); }
        #btn-kill { position: fixed; bottom: 30px; right: 30px; width: 80px; height: 80px; background: #600; border: 2px solid #fff; border-radius: 50%; color: white; z-index: 200; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

<div id="timer-display">CARREGANDO...</div>
<div id="loading-screen">INICIALIZANDO MAPA 3D...</div>

<div id="ui">
    <b style="color:red">KIRA MODE</b>
</div>

<div id="joy-base"><div id="joy-knob"></div></div>
<div id="btn-kill">MATAR</div>

<script>
let scene, camera, renderer, player, clock;
let moveForward = 0, moveRight = 0;
let yaw = 0, pitch = 0.5;
let npcs = [];
let rotTouch = { id: -1, x: 0, y: 0 };
let loadTime = 5; // Tempo de espera em segundos

// Função do Contador Regressivo
const timerInterval = setInterval(() => {
    loadTime--;
    document.getElementById('timer-display').innerText = "3D OPEN IN: " + loadTime + "s";
    if (loadTime <= 0) {
        clearInterval(timerInterval);
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('timer-display').innerText = "LIVE 3D";
    }
}, 1000);

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x050505);
    scene.fog = new THREE.FogExp2(0x050505, 0.05);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    clock = new THREE.Clock();

    scene.add(new THREE.AmbientLight(0x444444));
    let light = new THREE.PointLight(0xff0000, 1, 50);
    light.position.set(0, 10, 0);
    scene.add(light);

    // Chão
    let floor = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshPhongMaterial({color: 0x111111}));
    floor.rotation.x = -Math.PI/2;
    scene.add(floor);

    // MAPA (Prédios, Museu, Casinhas)
    const addBox = (x, z, w, h, d, col) => {
        let b = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), new THREE.MeshPhongMaterial({color: col}));
        b.position.set(x, h/2, z);
        scene.add(b);
    };

    addBox(-15, -15, 6, 25, 6, 0x1a1a1a); // PRE
    addBox(0, -15, 6, 30, 6, 0x1a1a1a);  // PRE
    addBox(15, -15, 6, 25, 6, 0x1a1a1a); // PRE
    addBox(-10, 15, 12, 12, 10, 0x333333); // MUSEU
    
    // CASAS (CA) Canto direito
    for(let i=0; i<2; i++) {
        for(let j=0; j<3; j++) { addBox(15 + j*4, 15 + i*5, 3, 3, 3, 0x222222); }
    }

    // Player
    player = new THREE.Group();
    let body = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 0.8), new THREE.MeshPhongMaterial({color: 0x0000ff}));
    body.position.y = 0.8;
    player.add(body);
    scene.add(player);

    createNPC("L", 0, 5, 0xffff00, true);
    setupControls();
    animate();
}

function createNPC(name, x, z, col, isL) {
    let g = new THREE.Group();
    let b = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 0.8), new THREE.MeshPhongMaterial({color: col}));
    b.position.y = 0.8;
    g.add(b);

    if(isL) {
        let r = new THREE.Mesh(new THREE.RingGeometry(10.4, 10.6, 32), new THREE.MeshBasicMaterial({color: 0xff0000, side: THREE.DoubleSide}));
        r.rotation.x = Math.PI/2; r.position.y = 0.05; g.add(r);
    }
    g.position.set(x, 0, z);
    scene.add(g);
    npcs.push({mesh: g, name: name});

    let l = document.createElement('div');
    l.className = 'label'; l.id = 'label-'+name; l.innerText = name;
    document.body.appendChild(l);
}

function setupControls() {
    const base = document.getElementById('joy-base');
    const knob = document.getElementById('joy-knob');

    base.addEventListener('touchmove', (e) => {
        let t = e.targetTouches[0];
        let r = base.getBoundingClientRect();
        let dx = t.clientX - (r.left + 50);
        let dy = t.clientY - (r.top + 50);
        let d = Math.min(Math.sqrt(dx*dx + dy*dy), 40);
        let a = Math.atan2(dy, dx);
        knob.style.left = `calc(50% + ${Math.cos(a)*d}px)`;
        knob.style.top = `calc(50% + ${Math.sin(a)*d}px)`;
        moveForward = -Math.sin(a) * (d/40);
        moveRight = Math.cos(a) * (d/40);
    });

    base.addEventListener('touchend', () => {
        knob.style.left = knob.style.top = '50%';
        moveForward = moveRight = 0;
    });

    window.addEventListener('touchstart', (e) => {
        let t = e.touches[e.touches.length-1];
        if(t.clientX > window.innerWidth/2) {
            rotTouch.id = t.identifier; rotTouch.x = t.clientX; rotTouch.y = t.clientY;
        }
    });

    window.addEventListener('touchmove', (e) => {
        for(let i=0; i<e.touches.length; i++) {
            let t = e.touches[i];
            if(t.identifier === rotTouch.id) {
                yaw -= (t.clientX - rotTouch.x) * 0.007;
                pitch = Math.max(0.2, Math.min(1.2, pitch + (t.clientY - rotTouch.y) * 0.005));
                rotTouch.x = t.clientX; rotTouch.y = t.clientY;
            }
        }
    });
}

function animate() {
    requestAnimationFrame(animate);
    if(moveForward || moveRight) {
        player.position.x += (Math.cos(yaw) * moveRight + Math.sin(yaw) * moveForward) * 0.15;
        player.position.z += (Math.sin(yaw) * moveRight - Math.cos(yaw) * moveForward) * 0.15;
        player.rotation.y = yaw;
    }
    let d = 8;
    camera.position.set(
        player.position.x + Math.sin(yaw) * d * Math.cos(pitch),
        player.position.y + Math.sin(pitch) * d,
        player.position.z + Math.cos(yaw) * d * Math.cos(pitch)
    );
    camera.lookAt(player.position.x, player.position.y + 1, player.position.z);

    npcs.forEach(n => {
        let l = document.getElementById('label-' + n.name);
        let v = n.mesh.position.clone().add(new THREE.Vector3(0, 1.8, 0));
        v.project(camera);
        l.style.left = (v.x * 0.5 + 0.5) * window.innerWidth + 'px';
        l.style.top = (-(v.y * 0.5) + 0.5) * window.innerHeight + 'px';
        l.style.display = v.z < 1 ? 'block' : 'none';
    });
    renderer.render(scene, camera);
}

window.onload = init;
</script>
</body>
</html>

